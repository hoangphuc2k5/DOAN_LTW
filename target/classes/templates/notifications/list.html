<!DOCTYPE html>
<html lang="en" 
      xmlns:th="http://www.thymeleaf.org" 
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main}">
<head>
    <title>Notifications</title>
    <style>
        .notification-list {
            max-width: 900px;
            margin: 0 auto;
        }
        .notification-item {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            transition: background 0.2s;
            position: relative;
        }
        .notification-item:hover {
            background: #f8f9fa;
        }
        .notification-item.unread {
            background: #f0f8ff;
            border-left: 3px solid #0a95ff;
        }
        .notification-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #0a95ff;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            margin-right: 15px;
        }
        .notification-icon.SYSTEM { background: #6c757d; }
        .notification-icon.COMMENT { background: #17a2b8; }
        .notification-icon.ANSWER { background: #28a745; }
        .notification-icon.VOTE { background: #ffc107; color: #000; }
        .notification-icon.MESSAGE { background: #007bff; }
        .notification-content {
            flex: 1;
        }
        .notification-message {
            font-size: 14px;
            margin-bottom: 5px;
        }
        .notification-time {
            font-size: 12px;
            color: #6c757d;
        }
        .notification-actions {
            display: flex;
            gap: 8px;
        }
        .unread-badge {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #0a95ff;
            border-radius: 50%;
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <div layout:fragment="content">
        <div class="container mt-4">
            <div class="notification-list">
                <!-- Header -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>
                        <i class="bi bi-bell"></i> Notifications
                        <span th:if="${unreadCount > 0}" class="badge bg-primary" th:text="${unreadCount}">0</span>
                    </h2>
                    <div>
                        <form th:action="@{/notifications/mark-all-read}" method="post" style="display: inline;">
                            <button type="submit" class="btn btn-outline-primary btn-sm" 
                                    th:disabled="${unreadCount == 0}">
                                <i class="bi bi-check-all"></i> Mark All as Read
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Flash Messages -->
                <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
                    <span th:text="${successMessage}">Success</span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
                <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
                    <span th:text="${errorMessage}">Error</span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>

                <!-- Empty State -->
                <div th:if="${notifications.isEmpty()}" class="text-center py-5">
                    <i class="bi bi-bell-slash" style="font-size: 64px; color: #dee2e6;"></i>
                    <h4 class="mt-3 text-muted">No notifications yet</h4>
                    <p class="text-muted">When you get notifications, they'll show up here.</p>
                </div>

                <!-- Notifications List -->
                <div class="card" th:if="${!notifications.isEmpty()}">
                    <div class="list-group list-group-flush">
                        <div th:each="notification : ${notifications}" 
                             class="list-group-item notification-item"
                             th:classappend="${!notification.isRead} ? 'unread' : ''">
                            
                            <div class="d-flex align-items-start">
                                <!-- Icon -->
                                <div class="notification-icon" th:classappend="${notification.type}">
                                    <i th:class="${notification.type == 'SYSTEM' ? 'bi bi-info-circle' : 
                                                   notification.type == 'COMMENT' ? 'bi bi-chat-dots' :
                                                   notification.type == 'ANSWER' ? 'bi bi-check-circle' :
                                                   notification.type == 'VOTE' ? 'bi bi-arrow-up' :
                                                   notification.type == 'MESSAGE' ? 'bi bi-envelope' :
                                                   'bi bi-bell'}"></i>
                                </div>

                                <!-- Content -->
                                <div class="notification-content">
                                    <div class="notification-message">
                                        <a th:if="${notification.link}" 
                                           th:href="${notification.link}"
                                           th:text="${notification.message}"
                                           class="text-decoration-none text-dark">
                                            Notification message
                                        </a>
                                        <span th:unless="${notification.link}" 
                                              th:text="${notification.message}">
                                            Notification message
                                        </span>
                                        <span th:if="${!notification.isRead}" class="unread-badge"></span>
                                    </div>
                                    <div class="notification-time">
                                        <i class="bi bi-clock"></i>
                                        <span th:text="${#temporals.format(notification.createdAt, 'MMM dd, yyyy HH:mm')}">
                                            Jan 01, 2025 12:00
                                        </span>
                                        <span th:if="${notification.sender}" class="ms-2">
                                            from <strong th:text="${notification.sender.username}">user</strong>
                                        </span>
                                    </div>
                                </div>

                                <!-- Actions -->
                                <div class="notification-actions ms-auto">
                                    <!-- Mark as read (if unread) -->
                                    <button th:if="${!notification.isRead}"
                                            type="button"
                                            class="btn btn-sm btn-outline-primary mark-read-btn"
                                            th:attr="data-id=${notification.id}"
                                            title="Mark as read">
                                        <i class="bi bi-check"></i>
                                    </button>

                                    <!-- Delete -->
                                    <form th:action="@{/notifications/{id}/delete(id=${notification.id})}" 
                                          method="post" 
                                          style="display: inline;"
                                          onsubmit="return confirm('Delete this notification?');">
                                        <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pagination (if needed later) -->
                <div class="mt-4 text-center" th:if="${notifications.size() >= 20}">
                    <button class="btn btn-outline-secondary">Load More</button>
                </div>
            </div>
        </div>

        <script>
            // Mark as read via AJAX
            document.querySelectorAll('.mark-read-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const notificationId = this.dataset.id;
                    const notificationItem = this.closest('.notification-item');
                    
                    fetch(`/notifications/${notificationId}/mark-read`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            // Remove unread styling
                            notificationItem.classList.remove('unread');
                            // Remove the mark-read button
                            this.remove();
                            // Update unread count badge
                            const badge = document.querySelector('.badge.bg-primary');
                            if (badge) {
                                const count = parseInt(badge.textContent) - 1;
                                if (count > 0) {
                                    badge.textContent = count;
                                } else {
                                    badge.remove();
                                }
                            }
                        }
                    })
                    .catch(error => console.error('Error:', error));
                });
            });

            // Auto-refresh unread count every 30 seconds
            setInterval(() => {
                fetch('/notifications/api/unread-count')
                    .then(response => response.json())
                    .then(data => {
                        const badge = document.querySelector('.badge.bg-primary');
                        if (data.count > 0) {
                            if (badge) {
                                badge.textContent = data.count;
                            } else {
                                const h2 = document.querySelector('h2');
                                const newBadge = document.createElement('span');
                                newBadge.className = 'badge bg-primary';
                                newBadge.textContent = data.count;
                                h2.appendChild(document.createTextNode(' '));
                                h2.appendChild(newBadge);
                            }
                        } else if (badge) {
                            badge.remove();
                        }
                    });
            }, 30000);
        </script>
    </div>
</body>
</html>

