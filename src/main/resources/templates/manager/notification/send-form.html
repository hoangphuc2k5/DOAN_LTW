<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main}">
<head>
  <title th:text="${pageTitle}">G·ª≠i th√¥ng b√°o</title>
</head>
<body>
<div layout:fragment="content">

  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h1 class="h4 mb-0 text-dark">
        <i class="bi bi-megaphone text-danger"></i> G·ª≠i th√¥ng b√°o
      </h1>
      <p class="text-muted mb-0">G·ª≠i th√¥ng b√°o ƒë·∫øn to√†n h·ªá th·ªëng ho·∫∑c ng∆∞·ªùi d√πng c·ª• th·ªÉ.</p>
    </div>
    <a th:href="@{/manager/notifications}" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left"></i> Quay l·∫°i
    </a>
  </div>

  <!-- Alert Messages -->
  <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
    <i class="bi bi-check-circle"></i> <span th:text="${successMessage}"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>
  
  <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
    <i class="bi bi-exclamation-triangle"></i> <span th:text="${errorMessage}"></span>
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  </div>

  <div class="card border-0 shadow-sm">
    <div class="card-body">
      <form th:action="@{/manager/notifications/send}" method="post">
        
        <!-- Message Content -->
        <div class="mb-4">
          <label class="form-label fw-bold">
            <i class="bi bi-envelope-fill"></i> N·ªôi dung th√¥ng b√°o <span class="text-danger">*</span>
          </label>
          <textarea class="form-control form-control-lg" 
                    name="message" 
                    rows="5" 
                    placeholder="Nh·∫≠p n·ªôi dung th√¥ng b√°o..."
                    required
                    maxlength="500"></textarea>
          <small class="form-text text-muted">T·ªëi ƒëa 500 k√Ω t·ª±</small>
        </div>

        <!-- Notification Type -->
        <div class="mb-4">
          <label class="form-label fw-bold">
            <i class="bi bi-tag-fill"></i> Lo·∫°i th√¥ng b√°o
          </label>
          <select class="form-select" name="type">
            <option value="SYSTEM" selected>üîî System (H·ªá th·ªëng)</option>
            <option value="QUESTION">‚ùì Question (C√¢u h·ªèi)</option>
            <option value="ANSWER">‚úÖ Answer (C√¢u tr·∫£ l·ªùi)</option>
            <option value="COMMENT">üí¨ Comment (B√¨nh lu·∫≠n)</option>
            <option value="MESSAGE">üìß Message (Tin nh·∫Øn)</option>
            <option value="VOTE">üëç Vote (B√¨nh ch·ªçn)</option>
            <option value="EVENT">üìÖ Event (S·ª± ki·ªán)</option>
          </select>
        </div>

        <!-- Link (Optional) -->
        <div class="mb-4">
          <label class="form-label fw-bold">
            <i class="bi bi-link-45deg"></i> ƒê∆∞·ªùng d·∫´n (t√πy ch·ªçn)
          </label>
          <input type="text" 
                 class="form-control" 
                 name="link" 
                 placeholder="VD: /questions/123, /profile/username">
          <small class="form-text text-muted">
            ƒê∆∞·ªùng d·∫´n khi ng∆∞·ªùi d√πng click v√†o th√¥ng b√°o
          </small>
        </div>

        <!-- Target User -->
        <div class="mb-4">
          <label class="form-label fw-bold">
            <i class="bi bi-people-fill"></i> Ng∆∞·ªùi nh·∫≠n <span class="text-danger">*</span>
          </label>
          <select class="form-select form-select-lg" name="target" id="targetSelect">
            <optgroup label="G·ª≠i h√†ng lo·∫°t">
              <option value="all" selected>üì¢ T·∫•t c·∫£ ng∆∞·ªùi d√πng</option>
              <option value="role:USER">üë§ USER</option>
              <option value="role:MANAGER">üë®‚Äçüíº MANAGER</option>
              <option value="role:ADMIN">üëë ADMIN</option>
            </optgroup>
          </select>
          <small class="form-text text-muted">
            Ch·ªçn g·ª≠i h√†ng lo·∫°t theo role ho·∫∑c ch·ªçn user c·ª• th·ªÉ
          </small>
        </div>

        <!-- Preview Card -->
        <div class="card bg-light mb-4">
          <div class="card-header">
            <h6 class="mb-0"><i class="bi bi-eye"></i> Preview</h6>
          </div>
          <div class="card-body">
            <div class="alert alert-info mb-0" role="alert">
              <div class="d-flex align-items-start">
                <i class="bi bi-bell-fill me-2 mt-1"></i>
                <div>
                  <strong id="previewType">SYSTEM</strong>
                  <p class="mb-1" id="previewMessage">N·ªôi dung th√¥ng b√°o s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y...</p>
                  <small class="text-muted">
                    G·ª≠i ƒë·∫øn: <strong id="previewTarget">T·∫•t c·∫£ ng∆∞·ªùi d√πng</strong>
                  </small>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Buttons -->
        <div class="d-flex justify-content-between">
          <a th:href="@{/manager/notifications}" class="btn btn-secondary px-4">
            <i class="bi bi-x-circle"></i> H·ªßy
          </a>
          <button type="submit" class="btn btn-primary px-4 btn-lg">
            <i class="bi bi-send-fill"></i> G·ª≠i th√¥ng b√°o
          </button>
        </div>
      </form>
    </div>
  </div>

</div>

<th:block layout:fragment="extra-scripts">
<script>
// Wait for DOM to be fully loaded
document.addEventListener('DOMContentLoaded', function() {
    console.log('üîÑ Initializing Preview...');
    
    // Live Preview
    const messageTextarea = document.querySelector('textarea[name="message"]');
    const typeSelect = document.querySelector('select[name="type"]');
    const targetSelect = document.getElementById('targetSelect');
    const previewMessage = document.getElementById('previewMessage');
    const previewType = document.getElementById('previewType');
    const previewTarget = document.getElementById('previewTarget');
    
    console.log('‚úÖ Elements found:', {
        messageTextarea: !!messageTextarea,
        typeSelect: !!typeSelect,
        targetSelect: !!targetSelect,
        previewMessage: !!previewMessage,
        previewType: !!previewType,
        previewTarget: !!previewTarget
    });

    function updatePreview() {
        console.log('üìù Updating preview...');
        
        if (!messageTextarea || !typeSelect || !targetSelect || 
            !previewMessage || !previewType || !previewTarget) {
            console.error('‚ùå Missing elements!');
            return;
        }
        
        // Update message
        const message = messageTextarea.value.trim();
        previewMessage.textContent = message || 'N·ªôi dung th√¥ng b√°o s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y...';
        console.log('Message:', message);
        
        // Update type
        const type = typeSelect.options[typeSelect.selectedIndex].text;
        previewType.textContent = type;
        console.log('Type:', type);
        
        // Update target
        const targetValue = targetSelect.value;
        if (targetValue === 'all') {
            previewTarget.textContent = 'T·∫•t c·∫£ ng∆∞·ªùi d√πng';
        } else if (targetValue.startsWith('role:')) {
            const role = targetValue.substring(5);
            const roleIcons = {
                'USER': 'üë§',
                'MANAGER': 'üë®‚Äçüíº',
                'ADMIN': 'üëë'
            };
            previewTarget.textContent = (roleIcons[role] || '') + ' T·∫•t c·∫£ ' + role;
        } else {
            const selectedText = targetSelect.options[targetSelect.selectedIndex].text;
            previewTarget.textContent = selectedText;
        }
        console.log('Target:', targetValue);
    }

    // Add event listeners
    if (messageTextarea) {
        messageTextarea.addEventListener('input', updatePreview);
        console.log('‚úÖ Message listener added');
    }
    
    if (typeSelect) {
        typeSelect.addEventListener('change', updatePreview);
        console.log('‚úÖ Type listener added');
    }
    
    if (targetSelect) {
        targetSelect.addEventListener('change', updatePreview);
        console.log('‚úÖ Target listener added');
    }

    // Character counter
    if (messageTextarea) {
        messageTextarea.addEventListener('input', function() {
            const length = this.value.length;
            const maxLength = this.getAttribute('maxlength');
            
            // Show counter if close to limit
            if (length > maxLength * 0.8) {
                const existingCounter = this.parentElement.querySelector('.char-counter');
                if (!existingCounter) {
                    const counter = document.createElement('small');
                    counter.className = 'char-counter text-muted float-end';
                    counter.textContent = `${length}/${maxLength}`;
                    this.parentElement.appendChild(counter);
                } else {
                    existingCounter.textContent = `${length}/${maxLength}`;
                }
            }
        });
    }

    // Initialize preview
    updatePreview();
    console.log('‚úÖ Preview initialized!');
});
</script>
</th:block>

<style>
  [layout\:fragment="content"] { 
    animation: fadeIn 0.3s ease-in-out; 
  }
  @keyframes fadeIn { 
    from { opacity: 0; transform: translateY(5px); } 
    to { opacity: 1; transform: translateY(0); } 
  }
  
  .form-select option {
    padding: 8px;
  }
</style>

</body>
</html>
