<!DOCTYPE html>
<html lang="vi" 
      xmlns:th="http://www.thymeleaf.org" 
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main}">
<head>
    <title>Ask a Question</title>
</head>
<body>
<div layout:fragment="content">
    <!-- Page Header -->
    <div class="mb-4">
        <h1 class="h2 mb-2">
            <i class="bi bi-question-circle-fill text-primary"></i> ƒê·∫∑t c√¢u h·ªèi
        </h1>
        <p class="text-muted mb-0">
            Nh·∫≠n tr·ª£ gi√∫p t·ª´ c·ªông ƒë·ªìng ng∆∞·ªùi d√πng
        </p>
    </div>

    <!-- Error/Success Messages -->
    <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle-fill"></i>
        <strong>Error:</strong> <span th:text="${error}">Error message</span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    
    <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
        <i class="bi bi-check-circle-fill"></i>
        <strong>Success:</strong> <span th:text="${successMessage}">Success message</span>
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>

    <!-- Ask Question Form -->
    <form th:action="@{/questions/ask}" method="post" enctype="multipart/form-data" id="askQuestionForm">
        <!-- Title -->
        <div class="card mb-4">
            <div class="card-header bg-white">
                <h5 class="mb-0">
                    <i class="bi bi-pencil"></i> Title
                </h5>
            </div>
            <div class="card-body">
                <label for="title" class="form-label">
                    Ti√™u ƒë·ªÅ c√¢u h·ªèi
                </label>
                <input type="text" 
                       class="form-control form-control-lg" 
                       id="title" 
                       name="title" 
                       placeholder="Nh·∫≠p ti√™u ƒë·ªÅ c√¢u h·ªèi c·ªßa b·∫°n..."
                       required 
                       maxlength="200">
                <div class="form-text d-flex justify-content-between">
                    <span>
                        <i class="bi bi-info-circle"></i> T·ªëi ƒëa 200 k√Ω t·ª±
                    </span>
                    <span id="titleCounter" class="text-muted">
                        <span id="titleCount">0</span>/200
                    </span>
                </div>
            </div>
        </div>

        <!-- Body -->
        <div class="card mb-4">
            <div class="card-header bg-white">
                <h5 class="mb-0">
                    <i class="bi bi-file-text"></i> Body
                </h5>
            </div>
            <div class="card-body">
                <label for="body" class="form-label">
                    N·ªôi dung c√¢u h·ªèi
                </label>
                
                <!-- Markdown Toolbar -->
                <div class="btn-toolbar mb-2 border-bottom pb-2" role="toolbar">
                    <div class="btn-group btn-group-sm me-2">
                        <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('**', '**')" title="Bold">
                            <i class="bi bi-type-bold"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('*', '*')" title="Italic">
                            <i class="bi bi-type-italic"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('`', '`')" title="Code">
                            <i class="bi bi-code"></i>
                        </button>
                    </div>
                    <div class="btn-group btn-group-sm me-2">
                        <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('\n```\n', '\n```\n')" title="Code Block">
                            <i class="bi bi-code-square"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('[', '](url)')" title="Link">
                            <i class="bi bi-link"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('\n- ', '')" title="Bullet List">
                            <i class="bi bi-list-ul"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('\n1. ', '')" title="Numbered List">
                            <i class="bi bi-list-ol"></i>
                        </button>
                    </div>
                    <div class="btn-group btn-group-sm">
                        <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('\n> ', '')" title="Quote">
                            <i class="bi bi-quote"></i>
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="insertMarkdown('\n## ', '')" title="Heading">
                            <i class="bi bi-type-h2"></i>
                        </button>
                    </div>
                </div>

                <textarea class="form-control" 
                          id="body" 
                          name="body" 
                          rows="12"
                          required></textarea>
                <div class="form-text d-flex justify-content-between mt-2">
                    <span></span>
                    <span id="bodyCounter" class="text-muted">
                        <span id="bodyCount">0</span> k√Ω t·ª±
                    </span>
                </div>

                <!-- Image Upload Section -->
                <div class="mt-3">
                    <label for="files" class="form-label">
                        <i class="bi bi-image"></i> Th√™m h√¨nh ·∫£nh
                    </label>
                    <input type="file" 
                           class="form-control" 
                           id="files" 
                           name="files" 
                           multiple 
                           accept="image/*"
                           onchange="previewImages(event)">
                    <div id="imagePreviewContainer" class="d-flex flex-wrap gap-2 mt-2"></div>
                </div>

                <div class="form-text">
                    <i class="bi bi-markdown"></i> H·ªó tr·ª£ ƒë·ªãnh d·∫°ng Markdown
                </div>
            </div>
        </div>

        <!-- Tags -->
        <div class="card mb-4">
            <div class="card-header bg-white">
                <h5 class="mb-0">
                    <i class="bi bi-tags"></i> Tags
                </h5>
            </div>
            <div class="card-body">
                <label for="tags" class="form-label">
                    Tags (T√πy ch·ªçn)
                </label>
                <input type="text" 
                       class="form-control" 
                       id="tags" 
                       placeholder="Nh·∫≠p tags, c√°ch nhau b·∫±ng d·∫•u c√°ch..."
                       autocomplete="off">
                <!-- Hidden input for form binding to Question.tagString -->
                <input type="hidden" id="tagString" name="tagString">
                <div class="form-text">
                    <i class="bi bi-info-circle"></i> T·ªëi ƒëa 5 tags. B·∫Øt ƒë·∫ßu nh·∫≠p ƒë·ªÉ xem g·ª£i √Ω ho·∫∑c t·∫°o tag m·ªõi.
                </div>
                
                <!-- Selected Tags Display -->
                <div id="selectedTags" class="mt-2 d-flex flex-wrap gap-2"></div>
                
                <!-- Autocomplete Dropdown (relative positioning) -->
                <div id="tagAutocomplete" class="border rounded shadow-sm bg-white mt-1" style="display: none; position: relative; z-index: 1000; max-height: 300px; overflow-y: auto;">
                    <!-- Tags will be populated here -->
                </div>
                
                <!-- Popular Tags Suggestions (Dynamic) -->
                <div class="mt-3">
                    <small class="text-muted d-block mb-2">Tags ph·ªï bi·∫øn:</small>
                    <div id="popularTagsContainer" class="d-flex flex-wrap gap-2">
                        <!-- Tags will be loaded dynamically from API -->
                        <div class="spinner-border spinner-border-sm text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="card mb-4">
            <div class="card-body bg-light">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-send"></i> ƒêƒÉng c√¢u h·ªèi
                        </button>
                        <a th:href="@{/}" class="btn btn-outline-secondary btn-lg ms-2">
                            <i class="bi bi-x-circle"></i> H·ªßy
                        </a>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="termsCheck" required>
                        <label class="form-check-label small" for="termsCheck">
                            T√¥i ƒë·ªìng √Ω v·ªõi <a href="#">ƒëi·ªÅu kho·∫£n d·ªãch v·ª•</a> v√† <a href="#">quy t·∫Øc ·ª©ng x·ª≠</a>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </form>

    <!-- Markdown Help Modal -->
    <div class="modal fade" id="markdownHelpModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-markdown"></i> Markdown Formatting Guide
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>You type</th>
                                <th>You get</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><code>**bold text**</code></td>
                                <td><strong>bold text</strong></td>
                            </tr>
                            <tr>
                                <td><code>*italic text*</code></td>
                                <td><em>italic text</em></td>
                            </tr>
                            <tr>
                                <td><code>`code`</code></td>
                                <td><code>code</code></td>
                            </tr>
                            <tr>
                                <td><code>```<br>code block<br>```</code></td>
                                <td><pre>code block</pre></td>
                            </tr>
                            <tr>
                                <td><code>[link](http://url)</code></td>
                                <td><a href="#">link</a></td>
                            </tr>
                            <tr>
                                <td><code>- list item</code></td>
                                <td>‚Ä¢ list item</td>
                            </tr>
                            <tr>
                                <td><code>> quote</code></td>
                                <td><blockquote>quote</blockquote></td>
                            </tr>
                            <tr>
                                <td><code>## Heading</code></td>
                                <td><h2>Heading</h2></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<th:block layout:fragment="extra-scripts">
<script>
// Markdown toolbar functions
function insertMarkdown(before, after) {
    const textarea = document.getElementById('body');
    const start = textarea.selectionStart;
    const end = textarea.selectionEnd;
    const text = textarea.value;
    const selected = text.substring(start, end);
    
    const newText = text.substring(0, start) + before + selected + after + text.substring(end);
    textarea.value = newText;
    
    // Set cursor position
    const newCursorPos = start + before.length + selected.length;
    textarea.setSelectionRange(newCursorPos, newCursorPos);
    textarea.focus();
}

// Add tag function
function addTag(tag) {
    const tagsInput = document.getElementById('tags');
    const currentTags = tagsInput.value.trim();
    const tagsArray = currentTags ? currentTags.split(' ') : [];
    
    if (!tagsArray.includes(tag) && tagsArray.length < 5) {
        tagsArray.push(tag);
        tagsInput.value = tagsArray.join(' ');
    }
}

// Preview toggle
function togglePreview() {
    const preview = document.getElementById('preview');
    const body = document.getElementById('body').value;
    const previewContent = document.getElementById('previewContent');
    
    if (preview.style.display === 'none') {
        // Simple markdown to HTML conversion (basic)
        let html = body
            .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
            .replace(/\*(.+?)\*|_(.+?)_/g, '<em>$1$2</em>')
            .replace(/`(.+?)`/g, '<code>$1</code>')
            .replace(/^### (.+)$/gm, '<h3>$1</h3>')
            .replace(/^## (.+)$/gm, '<h2>$1</h2>')
            .replace(/^# (.+)$/gm, '<h1>$1</h1>')
            .replace(/\n/g, '<br>');
        
        previewContent.innerHTML = html;
        preview.style.display = 'block';
    } else {
        preview.style.display = 'none';
    }
}

// Form validation and pre-submit processing
document.getElementById('askQuestionForm').addEventListener('submit', function(event) {
    const title = document.getElementById('title').value.trim();
    const body = document.getElementById('body').value.trim();
    const tags = document.getElementById('tags').value.trim();
    
    let isValid = true;
    let errorMessage = '';
    
    if (title.length === 0) {
        errorMessage += '- Ti√™u ƒë·ªÅ kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng\n';
        isValid = false;
    }
    
    if (body.length === 0) {
        errorMessage += '- N·ªôi dung kh√¥ng ƒë∆∞·ª£c ƒë·ªÉ tr·ªëng\n';
        isValid = false;
    }
    
    const tagsArray = tags.split(' ').filter(t => t.length > 0);
    if (tagsArray.length > 5) {
        errorMessage += '- T·ªëi ƒëa 5 tags\n';
        isValid = false;
    }
    
    if (!document.getElementById('termsCheck').checked) {
        errorMessage += '- B·∫°n ph·∫£i ƒë·ªìng √Ω v·ªõi ƒëi·ªÅu kho·∫£n d·ªãch v·ª•\n';
        isValid = false;
    }
    
    if (!isValid) {
        event.preventDefault();
        alert('Vui l√≤ng s·ª≠a c√°c l·ªói sau:\n\n' + errorMessage);
        return;
    }
    
    // Convert space-separated tags to comma-separated for backend
    // Backend expects: "tag1,tag2,tag3" or "tag1, tag2, tag3"
    document.getElementById('tagString').value = tagsArray.join(',');
    console.log('üì§ Submitting with tagString:', document.getElementById('tagString').value);
});

// Auto-save to localStorage
const title = document.getElementById('title');
const body = document.getElementById('body');
const tags = document.getElementById('tags');

[title, body, tags].forEach(element => {
    // Load saved data
    const saved = localStorage.getItem('ask_' + element.id);
    if (saved && element.value === '') {
        element.value = saved;
    }
    
    // Save on input
    element.addEventListener('input', function() {
        localStorage.setItem('ask_' + element.id, element.value);
    });
});

// Clear localStorage on successful submit
document.getElementById('askQuestionForm').addEventListener('submit', function() {
    localStorage.removeItem('ask_title');
    localStorage.removeItem('ask_body');
    localStorage.removeItem('ask_tags');
});

// Character counters
title.addEventListener('input', function() {
    const count = this.value.length;
    const countSpan = document.getElementById('titleCount');
    const counterSpan = document.getElementById('titleCounter');
    
    countSpan.textContent = count;
    
    if (count === 0) {
        counterSpan.className = 'text-danger';
    } else if (count > 180) {
        counterSpan.className = 'text-warning';
    } else {
        counterSpan.className = 'text-success';
    }
});

body.addEventListener('input', function() {
    const count = this.value.length;
    const countSpan = document.getElementById('bodyCount');
    const counterSpan = document.getElementById('bodyCounter');
    
    countSpan.textContent = count;
    
    if (count === 0) {
        counterSpan.className = 'text-danger';
    } else {
        counterSpan.className = 'text-success';
    }
});

// Trigger initial character count (for localStorage restored values)
if (title.value) {
    title.dispatchEvent(new Event('input'));
}
if (body.value) {
    body.dispatchEvent(new Event('input'));
}

// Image preview function
function previewImages(event) {
    const container = document.getElementById('imagePreviewContainer');
    container.innerHTML = ''; // Clear previous previews
    
    Array.from(event.target.files).forEach(file => {
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = document.createElement('img');
            img.src = e.target.result;
            img.classList.add('img-thumbnail', 'me-2');
            img.style.width = '100px'; // Set a fixed width for thumbnails
            img.style.height = 'auto';
            
            container.appendChild(img);
        }
        reader.readAsDataURL(file);
    });
}

// ==================== TAG AUTOCOMPLETE ====================
let allTags = [];
let allTagsData = []; // Store full tag objects with questionCount

// Fetch all tags from API when page loads
console.log('üîÑ Starting to fetch tags...');
fetch('/api/tags/all')
    .then(response => {
        console.log('‚úÖ API response received:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('üì¶ Tags data:', data);
        allTagsData = data;
        allTags = data.map(tag => tag.name || tag);
        console.log('‚úÖ Loaded tags:', allTags.length, 'tags');
        console.log('First 5 tags:', allTags.slice(0, 5));
        
        // Render popular tags dynamically
        renderPopularTags(allTagsData);
    })
    .catch(error => {
        console.error('‚ùå Error loading tags:', error);
        // Fallback to popular tags if API fails
        allTags = ['java', 'javascript', 'python', 'spring-boot', 'react', 'sql', 'database', 'html', 'css', 'nodejs', 'c++', 'csharp', 'php', 'ruby', 'go'];
        console.log('‚ö†Ô∏è Using fallback tags:', allTags.length);
        
        // Render fallback tags
        const fallbackData = allTags.map(name => ({name: name, questionCount: 0}));
        renderPopularTags(fallbackData);
    });

// Render popular tags as clickable buttons
function renderPopularTags(tagsData) {
    const container = document.getElementById('popularTagsContainer');
    if (!container) return;
    
    // Sort by questionCount (descending) to show most popular first
    const sortedTags = [...tagsData].sort((a, b) => (b.questionCount || 0) - (a.questionCount || 0));
    
    // Render all tags (no limit)
    let html = '';
    sortedTags.forEach(tag => {
        const name = tag.name || tag;
        const count = tag.questionCount || 0;
        html += `
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addTag('${name}')" title="${count} questions">
                ${name} <span class="badge bg-secondary">${count}</span>
            </button>
        `;
    });
    
    container.innerHTML = html;
    console.log('‚úÖ Rendered', sortedTags.length, 'popular tags');
}

const tagsInput = document.getElementById('tags');
const tagAutocomplete = document.getElementById('tagAutocomplete');

// Show autocomplete on focus
tagsInput.addEventListener('focus', function() {
    console.log('üéØ Input focused, showing suggestions');
    showTagSuggestions('');
});

// Show autocomplete on click
tagsInput.addEventListener('click', function() {
    console.log('üñ±Ô∏è Input clicked, showing suggestions');
    showTagSuggestions('');
});

// Update autocomplete on input
tagsInput.addEventListener('input', function() {
    const currentInput = this.value;
    const lastSpaceIndex = currentInput.lastIndexOf(' ');
    const currentTag = currentInput.substring(lastSpaceIndex + 1).trim();
    
    console.log('‚å®Ô∏è Input changed, current tag:', currentTag);
    showTagSuggestions(currentTag);
});

// Hide autocomplete when clicking outside
document.addEventListener('click', function(e) {
    if (e.target !== tagsInput && !tagAutocomplete.contains(e.target)) {
        tagAutocomplete.style.display = 'none';
        console.log('üëÜ Clicked outside, hiding dropdown');
    }
});

// Show tag suggestions
function showTagSuggestions(filter) {
    console.log('üîç Showing suggestions for filter:', filter);
    console.log('üìä Available tags:', allTags.length);
    
    const currentTags = tagsInput.value.trim().split(' ').filter(t => t.length > 0);
    console.log('üè∑Ô∏è Current tags:', currentTags);
    
    // Filter tags: exclude already added tags, and filter by search term
    const filteredTags = allTags
        .filter(tag => !currentTags.includes(tag))
        .filter(tag => filter === '' || tag.toLowerCase().includes(filter.toLowerCase()))
        .slice(0, 20); // Show max 20 suggestions
    
    console.log('‚ú® Filtered tags:', filteredTags.length);
    
    if (filteredTags.length === 0 && allTags.length === 0) {
        tagAutocomplete.innerHTML = '<div class="p-3 text-muted text-center"><i class="bi bi-hourglass-split"></i> Loading tags...</div>';
        tagAutocomplete.style.display = 'block';
        return;
    }
    
    if (filteredTags.length === 0) {
        tagAutocomplete.style.display = 'none';
        console.log('‚ùå No tags to show');
        return;
    }
    
    // Build dropdown HTML
    let html = '<div class="list-group list-group-flush">';
    filteredTags.forEach(tag => {
        const tagData = allTagsData.find(t => t.name === tag);
        const count = tagData ? tagData.questionCount || 0 : 0;
        html += `
            <button type="button" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center py-2" 
                    onclick="selectTagFromAutocomplete('${tag}')" style="cursor: pointer;">
                <span><i class="bi bi-tag-fill text-primary me-2"></i><strong>${tag}</strong></span>
                <span class="badge bg-secondary">${count}</span>
            </button>
        `;
    });
    html += '</div>';
    
    tagAutocomplete.innerHTML = html;
    tagAutocomplete.style.display = 'block';
    console.log('‚úÖ Dropdown shown with', filteredTags.length, 'tags');
}

// Select tag from autocomplete
function selectTagFromAutocomplete(tag) {
    console.log('‚úÖ Selected tag:', tag);
    const currentInput = tagsInput.value.trim();
    const lastSpaceIndex = currentInput.lastIndexOf(' ');
    
    let newValue;
    if (lastSpaceIndex === -1) {
        // No space found, replace entire input
        newValue = tag;
    } else {
        // Replace only the last tag being typed
        newValue = currentInput.substring(0, lastSpaceIndex + 1) + tag;
    }
    
    // Check if we already have 5 tags
    const tagsArray = newValue.split(' ').filter(t => t.length > 0);
    if (tagsArray.length < 5) {
        tagsInput.value = newValue + ' ';
    } else {
        tagsInput.value = newValue;
        alert('‚ö†Ô∏è T·ªëi ƒëa 5 tags!');
    }
    
    tagsInput.focus();
    tagAutocomplete.style.display = 'none';
}

// Enhanced addTag function (from popular tags buttons)
function addTag(tag) {
    console.log('‚ûï Adding tag from button:', tag);
    const tagsInput = document.getElementById('tags');
    const currentTags = tagsInput.value.trim();
    const tagsArray = currentTags ? currentTags.split(' ').filter(t => t.length > 0) : [];
    
    if (!tagsArray.includes(tag) && tagsArray.length < 5) {
        tagsArray.push(tag);
        tagsInput.value = tagsArray.join(' ') + ' ';
        tagsInput.focus();
        console.log('‚úÖ Tag added:', tag);
    } else if (tagsArray.length >= 5) {
        alert('‚ö†Ô∏è T·ªëi ƒëa 5 tags!');
    } else {
        console.log('‚ö†Ô∏è Tag already exists:', tag);
    }
}
</script>
</th:block>
</body>
</html>